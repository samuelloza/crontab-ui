<!doctype html>
<head>
    <title>Interfaz de Crontab</title>
    <script src="jquery.js"></script>
    <script src="script.js"></script>
    <script src="bootstrap.min.js"></script>
    <script src="mailconfig.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/v/bs/dt-1.10.12/datatables.min.js"></script>
    <link rel="stylesheet" href="css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.12/css/dataTables.bootstrap.min.css"/>
    <script type="text/javascript">
        var crontabs = [];
        var rutas = [];
        $(function () {
            // inicializar tooltips
            $('[data-toggle="tooltip"]').tooltip();
            crontabs = JSON.parse('<%- crontabs.replace(/\\\\/g, "\\\\\\\\").replace(/\"/g,"\\\"").replace(/\'/g,"\\'").replace(/\t/g, " ") %>');
            rutas = JSON.parse('<%- routes %>');
            $("#env_vars").val(`<%- env  %>`);
        })
    </script>
</head>
<body>
    <%- include('navbar.ejs') -%>
    <div class="container-fluid">
        <h2>Tareas Programadas (Cronjobs)</h2>
        <div class="form-group">
            <label for="env_vars">Variables de entorno:</label>
            <textarea class="form-control" rows="3" id="env_vars" placeholder="# Configure PATH, MAILTO, HOME... aquí"></textarea>
        </div>
        <a class="btn btn-primary" onclick="newJob();"><span class="glyphicon glyphicon-plus-sign" aria-hidden="true"></span> Nuevo</a>
        <a class="btn btn-info" onclick="doBackup();"><span class="glyphicon glyphicon-floppy-save" aria-hidden="true"></span> Copia de seguridad</a>
        <form id="import_form" enctype="multipart/form-data" action="<%= JSON.parse(rutas).import %>" method="post" style="display:none">
            <input type="file" id="import_file" name="import_file" onchange="$('#import_form').submit()"/>
        </form>
        <a class="btn btn-warning" onclick="import_db()"><span class="glyphicon glyphicon-import" aria-hidden="true"></span> Importar</a>
        <a class="btn btn-warning" href="<%= JSON.parse(rutas).export %>"><span class="glyphicon glyphicon-download-alt" aria-hidden="true"></span> Exportar</a>
        <a class="btn btn-success" onclick="getCrontab();"><span class="glyphicon glyphicon-open" aria-hidden="true"></span> Obtener desde Crontab</a>
        <a class="btn btn-success" onclick="setCrontab();"><span class="glyphicon glyphicon-save" aria-hidden="true"></span> Guardar en Crontab</a>
        <br/><br/>
        <table class="table table-striped" id="main_table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Nombre</th>
                    <th>Tarea</th>
                    <th>Horario</th>
                    <th>Última modificación</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                <% var index = 1 %>
                <% JSON.parse(crontabs).forEach(function(crontab){ %>
                    <tr <% if (crontab.stopped) { %>style="background:#3A6DA6;color:#fff"<% } %>>
                        <td><%= index++ %>.</td>
                        <td>
                            <% if (crontab.name) { %>
                                <%= crontab.name %>
                                <a class="btn" data-toggle="tooltip" data-placement="right" title="<%= crontab._id %>"><span class="glyphicon glyphicon-info-sign"></span></a>
                                <% if (crontab.saved) { %>
                                    <span class="glyphicon glyphicon-floppy-saved"></span>
                                <% } else { %>
                                    <a data-toggle="tooltip" data-placement="right" title="'Guardar en Crontab' para desplegar">
                                        <span class="glyphicon glyphicon-floppy-remove"></span>
                                    </a>
                                <% } %>
                            <% } else { %>
                                <%= crontab._id %>
                            <% } %>
                        </td>
                        <td><%= crontab.command %></td>
                        <td>
                            <span style="cursor:pointer" data-toggle="tooltip" data-placement="bottom" title="<%= crontab.next %>">
                                <%= crontab.schedule %>
                            </span>
                            <a class="btn" data-toggle="tooltip" data-placement="right" title="<%= crontab.human %>">
                                <span class="glyphicon glyphicon-info-sign"></span>
                            </a>
                        </td>
                        <td title="<%= crontab.timestamp %>"><%= moment(new Date(crontab.timestamp)).fromNow() %></td>
                        <td>
                            <% if (!crontab.stopped) { %>
                                <a class="btn btn-info" onclick="runJob('<%= crontab._id %>')"><span class="glyphicon glyphicon-play"></span> Ejecutar ahora</a>
                                <a class="btn btn-primary" onclick="editJob('<%= crontab._id %>')"><span class="glyphicon glyphicon-edit"></span> Editar</a>
                                <a class="btn btn-info" onclick="stopJob('<%= crontab._id %>')"><span class="glyphicon glyphicon-stop"></span> Desactivar</a>
                            <% } else { %>
                                <a class="btn btn-info" onclick="startJob('<%= crontab._id %>')"><span class="glyphicon glyphicon-play"></span> Activar</a>
                            <% } %>
                            <a class="btn btn-danger" onclick="deleteJob('<%= crontab._id %>')"><span class="glyphicon glyphicon-trash"></span> Eliminar</a>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
        </table>
    </div>
    <%- include('popup.ejs') -%>
    <script>
        jQuery(function($) {
            $('#main_table').DataTable({
                order: [1, 'asc'],
                columns: [
                    {orderable: false},
                    null,
                    null,
                    null,
                    {orderable: false},
                    {orderable: false}
                ],
                stateSave: true,
                stateDuration: 0
            });
        });
    </script>
</body>
</html>
